<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>调度器状态测试</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>调度器状态测试</h1>
    <div id="result">正在测试...</div>
    
    <script>
        // 设置Basic认证头
        const username = 'Admin';
        const password = '123456';
        const authHeader = 'Basic ' + btoa(username + ':' + password);
        
        async function testSchedulerStatus() {
            const resultDiv = document.getElementById('result');
            
            try {
                console.log('开始测试调度器状态API...');
                
                // 配置axios基础URL
                axios.defaults.baseURL = '/';
                
                console.log('请求URL: /api/quartz/GetSchedulerStatus');
                
                const response = await axios.get('/api/quartz/GetSchedulerStatus', {
                    headers: {
                        'Authorization': authHeader
                    }
                });
                
                console.log('API响应:', response);
                console.log('响应数据:', response.data);
                
                if (response.data.success) {
                    const data = response.data.data;
                    resultDiv.innerHTML = `
                        <div class="status success">
                            <h3>✅ API调用成功！</h3>
                            <p><strong>调度器名称:</strong> ${data.schedulerName}</p>
                            <p><strong>是否启动:</strong> ${data.isStarted}</p>
                            <p><strong>是否关闭:</strong> ${data.isShutdown}</p>
                            <p><strong>状态:</strong> ${data.status}</p>
                            <p><strong>作业数量:</strong> ${data.jobCount}</p>
                        </div>
                        <button onclick="testJobList()" style="margin: 10px 0; padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            测试作业列表API
                        </button>
                        <div id="jobListResult"></div>
                        <div class="info">
                            <h4>完整响应数据:</h4>
                            <pre>${JSON.stringify(response.data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="status error">
                            <h3>❌ API返回错误</h3>
                            <p><strong>消息:</strong> ${response.data.message}</p>
                            <p><strong>成功状态:</strong> ${response.data.success}</p>
                        </div>
                        <div class="info">
                            <h4>完整响应数据:</h4>
                            <pre>${JSON.stringify(response.data, null, 2)}</pre>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('API调用失败:', error);
                console.error('错误详情:', error.response || error.message);
                
                let errorMessage = '未知错误';
                if (error.response) {
                    errorMessage = `HTTP ${error.response.status}: ${error.response.statusText}`;
                } else if (error.request) {
                    errorMessage = '网络请求失败，请检查网络连接';
                } else {
                    errorMessage = error.message;
                }
                
                resultDiv.innerHTML = `
                    <div class="status error">
                        <h3>❌ API调用失败</h3>
                        <p><strong>错误信息:</strong> ${errorMessage}</p>
                        <p><strong>错误类型:</strong> ${error.name}</p>
                    </div>
                    <div class="info">
                        <h4>完整错误信息:</h4>
                        <pre>${JSON.stringify({
                            message: error.message,
                            name: error.name,
                            response: error.response ? {
                                status: error.response.status,
                                statusText: error.response.statusText,
                                data: error.response.data
                            } : null,
                            request: error.request ? '请求已发送但未收到响应' : null
                        }, null, 2)}</pre>
                    </div>
                `;
            }
        }
        
        async function testJobList() {
            const resultDiv = document.getElementById('jobListResult');
            
            try {
                console.log('开始测试作业列表API...');
                
                const response = await axios.post('/api/quartz/GetJobsAsync', {
                    pageIndex: 1,
                    pageSize: 10
                }, {
                    headers: {
                        'Authorization': authHeader,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('作业列表API响应:', response);
                
                if (response.data.success) {
                    const data = response.data.data;
                    
                    // 检查是否包含ClassJobs组的作业
                    const hasClassJobs = data.items.some(job => job.jobGroup === 'ClassJobs');
                    
                    resultDiv.innerHTML = `
                        <div class="status ${hasClassJobs ? 'success' : 'info'}">
                            <h3>✅ 作业列表API调用成功！</h3>
                            <p><strong>总作业数:</strong> ${data.totalCount}</p>
                            <p><strong>当前页作业数:</strong> ${data.items.length}</p>
                            <p><strong>是否包含自动注册的ClassJob:</strong> ${hasClassJobs ? '是' : '否'}</p>
                        </div>
                        <div class="info">
                            <h4>作业列表详情:</h4>
                            <pre>${JSON.stringify(data.items, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="status error">
                            <h3>❌ 作业列表API返回错误</h3>
                            <p><strong>消息:</strong> ${response.data.message}</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('作业列表API调用失败:', error);
                
                let errorMessage = '未知错误';
                if (error.response) {
                    errorMessage = `HTTP ${error.response.status}: ${error.response.statusText}`;
                } else if (error.request) {
                    errorMessage = '网络请求失败，请检查网络连接';
                } else {
                    errorMessage = error.message;
                }
                
                resultDiv.innerHTML = `
                    <div class="status error">
                        <h3>❌ 作业列表API调用失败</h3>
                        <p><strong>错误信息:</strong> ${errorMessage}</p>
                    </div>
                `;
            }
        }
        
        // 页面加载完成后自动测试
        window.addEventListener('load', testSchedulerStatus);
    </script>
</body>
</html>